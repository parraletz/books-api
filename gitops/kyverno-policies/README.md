# Kyverno Policies Documentation

This directory contains Kyverno policies for validating Kubernetes manifests generated by Helm templates.

## Policy Categories

### 1. Security (`security.yaml`)
- **Purpose**: Enforce security contexts and prevent privileged access
- **Rules**:
  - Require pod security context (non-root, fsGroup)
  - Require container security context (drop capabilities, read-only filesystem)
  - Block privileged containers
  - Block host PID/IPC/network access

### 2. Resources (`resources.yaml`)
- **Purpose**: Ensure proper resource allocation
- **Rules**:
  - Require CPU and memory requests
  - Require CPU and memory limits
  - Validate CPU limits (50m - 1000m)
  - Validate memory limits (64Mi - 1Gi)
  - Enforce request-to-limit ratio

### 3. Images (`images.yaml`)
- **Purpose**: Enforce secure container image practices
- **Rules**:
  - Allow only trusted registries
  - Require specific image tags (no 'latest')
  - Require proper image pull policy
  - Validate books-api uses correct image

### 4. Networking (`networking.yaml`)
- **Purpose**: Enforce secure networking practices
- **Rules**:
  - Require TLS for ingresses
  - Require cert-manager annotations
  - Validate service type (ClusterIP only)
  - Require health checks
  - Validate ingress class specification

### 5. Best Practices (`best-practices.yaml`)
- **Purpose**: Enforce general Kubernetes best practices
- **Rules**:
  - Require standard Kubernetes labels
  - Require replica count
  - Require serviceAccountName
  - Block sensitive data in ConfigMaps
  - Require termination grace period
  - Require DNS policy

## Usage

### Local Testing
```bash
# Install Kyverno CLI
curl -sSfL https://github.com/kyverno/kyverno/releases/download/v1.11.0/kyverno-cli_v1.11.0_linux_x86_64.tar.gz -o kyverno.tar.gz
tar -xzf kyverno.tar.gz
sudo mv kyverno /usr/local/bin/

# Test policies against rendered manifests
helm template books-api ./helm/books-api --values gitops/books.yaml \
  | kyverno validate gitops/kyverno-policies/ --resource -
```

### CI Integration
The policies are integrated into the CI workflow and will automatically validate Helm templates during pull requests and pushes.

### Policy Enforcement
- **validationFailureAction: Enforce** - Policies are enforced in the cluster
- **background: true** - Policies run continuously against existing resources
- **Namespace scoped** - Policies target the `books-api` namespace

## Policy Parameters

Most policies use hard-coded values suitable for the books-api application. Some key parameters:

- **Resource limits**: CPU 50m-1000m, Memory 64Mi-1Gi
- **Security contexts**: Non-root users (>=1000), read-only filesystem
- **Image registries**: ghcr.io, docker.io, k8s.gcr.io, gcr.io, quay.io
- **Service type**: ClusterIP only (no LoadBalancer/NodePort)

## Customization

To modify policies for different requirements:

1. Edit the appropriate `.yaml` file in this directory
2. Test locally with Kyverno CLI
3. Commit changes to trigger CI validation
4. Monitor policy enforcement in the cluster

## Policy Structure

Each policy follows the Kyverno structure:
```yaml
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: policy-name
  annotations:
    policies.kyverno.io/title: Policy Title
    policies.kyverno.io/category: Category
    policies.kyverno.io/subject: Kubernetes Resources
    policies.kyverno.io/description: Policy description
spec:
  validationFailureAction: Enforce
  background: true
  rules:
    - name: rule-name
      match:
        any:
          - resources:
              kinds: [ResourceTypes]
              namespaces: [books-api]
      validate:
        message: "Validation message"
        pattern: # Resource pattern to match
```

## Monitoring

Policy violations will appear in:
- CI workflow results
- Kyverno controller logs
- Kubernetes events
- ArgoCD sync status (if blocking)