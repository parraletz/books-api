apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: security-context
  namespace: ""
  annotations:
    policies.kyverno.io/title: Security Context Requirements
    policies.kyverno.io/category: Security
    policies.kyverno.io/subject: Pod, Deployment, StatefulSet, DaemonSet
    policies.kyverno.io/description: >-
      Enforces security contexts for pods and containers to ensure secure deployment
      practices including non-root execution, read-only filesystem, and privilege restrictions.
spec:
  validationFailureAction: Enforce
  background: true
  rules:
    - name: require-pod-security-context
      match:
        any:
          - resources:
              kinds:
                - Pod
                - Deployment
                - StatefulSet
                - DaemonSet
              namespaces:
                - books-api
      validate:
        message: "Pod security context is required"
        pattern:
          spec:
            template:
              spec:
                =(securityContext):
                  fsGroup: ">=1000"
                  runAsNonRoot: true
                  runAsUser: ">=1000"
    
    - name: require-container-security-context
      match:
        any:
          - resources:
              kinds:
                - Pod
                - Deployment
                - StatefulSet
                - DaemonSet
              namespaces:
                - books-api
      validate:
        message: "Container security context is required"
        pattern:
          spec:
            template:
              spec:
                containers:
                  - =(securityContext):
                      allowPrivilegeEscalation: false
                      capabilities:
                        drop:
                          - ALL
                      readOnlyRootFilesystem: true
                      runAsNonRoot: true
                      runAsUser: ">=1000"
    
    - name: block-privileged-containers
      match:
        any:
          - resources:
              kinds:
                - Pod
                - Deployment
                - StatefulSet
                - DaemonSet
              namespaces:
                - books-api
      validate:
        message: "Privileged containers are not allowed"
        pattern:
          spec:
            template:
              spec:
                containers:
                  - =(securityContext):
                      privileged: false
    
    - name: block-host-pid-ipc
      match:
        any:
          - resources:
              kinds:
                - Pod
                - Deployment
                - StatefulSet
                - DaemonSet
              namespaces:
                - books-api
      validate:
        message: "Host PID, IPC, and network access is not allowed"
        pattern:
          spec:
            template:
              spec:
                =(hostPID): false
                =(hostIPC): false
                =(hostNetwork): false