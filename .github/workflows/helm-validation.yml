name: Helm & Kyverno Validation

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

jobs:
  helm-kyverno-validation:
    name: Helm Template & Kyverno Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.12.0

      - name: Install Python YAML module
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install pyyaml

      - name: Extract ArgoCD valuesObject
        id: extract-values
        run: |
          echo "ðŸ” Extracting valuesObject from ArgoCD config..."

          # Determine environment based on branch
          if [[ "${{ github.ref_name }}" == "main" ]]; then
            ENV="production"
          else
            ENV="staging"
          fi

          echo "Environment: $ENV"
          echo "env=$ENV" >> $GITHUB_OUTPUT

          # Check if ArgoCD config exists
          if [ ! -f "gitops/books.yaml" ]; then
            echo "::error::ArgoCD config not found: gitops/books.yaml"
            exit 1
          fi

          # Extract valuesObject from ArgoCD config using Python
          python3 -c 'import yaml; import sys; data = yaml.safe_load(open("gitops/books.yaml")); values_object = data["spec"]["source"]["helm"]["valuesObject"]; yaml.dump(values_object, sys.stdout, default_flow_style=False)' > temp-values.yaml || { echo "::error::Failed to extract valuesObject"; exit 1; }

          echo "âœ… valuesObject extracted to temp-values.yaml"

          # Merge with environment-specific values if exists
          if [ -f "gitops/values-$ENV.yaml" ]; then
            echo "ðŸ”„ Merging with $ENV values..."
            python3 -c 'import yaml; base=yaml.safe_load(open("temp-values.yaml")); override=yaml.safe_load(open("gitops/values-'"$ENV"'.yaml")); merged={**base, **{k: {**base.get(k, {}), **v} if isinstance(v, dict) and k in base else v for k, v in override.items()}}; yaml.dump(merged, open("merged-values.yaml", "w"), default_flow_style=False)'
            mv merged-values.yaml temp-values.yaml
            echo "âœ… Merged with $ENV values"
          fi

          # Display key values
          echo "ðŸ“Š Key values to be used:"
          python3 -c 'import yaml; v=yaml.safe_load(open("temp-values.yaml")); print("  - Image tag:", v.get("image", {}).get("tag", "not specified")); print("  - Replicas:", v.get("replicaCount", "not specified")); print("  - Service type:", v.get("service", {}).get("type", "not specified")); print("  - Ingress enabled:", v.get("ingress", {}).get("enabled", "not specified"))'

      - name: Validate Helm chart syntax
        run: |
          echo "ðŸ” Validating Helm chart syntax..."

          if ! helm lint ./helm/books-api --values temp-values.yaml; then
            echo "::error::Helm chart lint failed"
            exit 1
          fi

          echo "âœ… Helm chart syntax is valid"

      - name: Render Helm templates
        run: |
          echo "ðŸ“‹ Rendering Helm templates..."

          # Create output directory
          mkdir -p rendered-manifests

          # Render templates with debug output
          if ! helm template books-api ./helm/books-api --values temp-values.yaml --output-dir rendered-manifests --debug; then
            echo "::error::Helm template rendering failed"
            exit 1
          fi

          echo "âœ… Templates rendered to rendered-manifests/"
          echo "ðŸ“ Generated files:"
          find rendered-manifests -name "*.yaml" -type f | wc -l | xargs echo "  - Total manifests:"
          find rendered-manifests -name "*.yaml" -type f | head -5 | sed 's|.*|    - |'

      - name: Validate with Kyverno CLI
        run: |
          echo "ðŸ›¡ï¸ Setting up Kyverno CLI..."

          # Check if policies exist
          if [ ! -d "gitops/kyverno-policies" ] || [ -z "$(ls -A gitops/kyverno-policies/*.yaml 2>/dev/null)" ]; then
            echo "âš ï¸ No Kyverno policies found in gitops/kyverno-policies/, skipping validation"
            echo "::warning::Consider adding Kyverno policies for enhanced security validation"
            exit 0
          fi

          # Count policies
          POLICY_COUNT=$(find gitops/kyverno-policies -name "*.yaml" -type f | wc -l)
          echo "ðŸ“‹ Found $POLICY_COUNT Kyverno policies"

          # Use Docker for Kyverno CLI (compatible with all architectures)
          KYVERNO_CMD="docker run --rm -v $(pwd):/workspace -w /workspace ghcr.io/kyverno/kyverno-cli:v1.11.0"

          echo "ðŸ›¡ï¸ Running Kyverno policy validation..."

          # Validate critical deployment first
          if ! $KYVERNO_CMD apply gitops/kyverno-policies/ --resource rendered-manifests/books-api/templates/deployment.yaml; then
            echo "::error::Kyverno policy validation failed for deployment"
            exit 1
          fi

          echo "âœ… Deployment passed Kyverno validation"

          # Validate all other resources
          MANIFEST_COUNT=0
          FAILED_COUNT=0

          for manifest in rendered-manifests/books-api/templates/*.yaml; do
            if [ -f "$manifest" ]; then
              MANIFEST_COUNT=$((MANIFEST_COUNT + 1))
              MANIFEST_NAME=$(basename "$manifest")

              echo "  ðŸ” Validating $MANIFEST_NAME..."

              if $KYVERNO_CMD apply gitops/kyverno-policies/ --resource "$manifest" > /dev/null 2>&1; then
                echo "    âœ… $MANIFEST_NAME passed"
              else
                echo "    âŒ $MANIFEST_NAME failed"
                FAILED_COUNT=$((FAILED_COUNT + 1))
                $KYVERNO_CMD apply gitops/kyverno-policies/ --resource "$manifest"
              fi
            fi
          done

          if [ $FAILED_COUNT -gt 0 ]; then
            echo "::error::Kyverno validation failed for $FAILED_COUNT out of $MANIFEST_COUNT resources"
            exit 1
          fi

          echo "âœ… All $MANIFEST_COUNT manifests passed Kyverno validation"

      - name: Generate validation report
        if: always()
        run: |
          echo "## ðŸ“Š Helm & Kyverno Validation Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ steps.extract-values.outputs.env }}" >> $GITHUB_STEP_SUMMARY
          echo "**Helm Chart:** books-api" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Helm validation results
          if [ -d "rendered-manifests/books-api/templates" ]; then
            MANIFEST_COUNT=$(find rendered-manifests/books-api/templates -name "*.yaml" -type f | wc -l)
            echo "### ðŸ“‹ Helm Templates" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Chart syntax: Valid" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ“„ Manifests generated: $MANIFEST_COUNT" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Kyverno validation results
          if [ -d "gitops/kyverno-policies" ] && [ "$(ls -A gitops/kyverno-policies)" ]; then
            POLICY_COUNT=$(find gitops/kyverno-policies -name "*.yaml" -type f | wc -l)
            echo "### ðŸ›¡ï¸ Kyverno Policies" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ“‹ Policies applied: $POLICY_COUNT" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Policy status: All passed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            echo "### ðŸ“ Generated Manifests" >> $GITHUB_STEP_SUMMARY
            if [ -d "rendered-manifests/books-api/templates" ]; then
              find rendered-manifests/books-api/templates -name "*.yaml" -type f | sed 's|.*|- |' >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### âš ï¸ Kyverno Policies" >> $GITHUB_STEP_SUMMARY
            echo "- No policies configured in gitops/kyverno-policies/" >> $GITHUB_STEP_SUMMARY
            echo "- Consider adding policies for enhanced security validation" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload validation artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: helm-validation-${{ steps.extract-values.outputs.env }}-${{ github.run_number }}
          path: |
            rendered-manifests/
            temp-values.yaml
          retention-days: 7

      - name: Cleanup temp files
        if: always()
        run: |
          echo "ðŸ§¹ Cleaning up temporary files..."
          rm -f temp-values.yaml merged-values.yaml
          rm -rf rendered-manifests
          echo "âœ… Cleanup completed"
